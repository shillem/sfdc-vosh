<template>
  <label lwc:if={label} class="slds-form-element__label" for="combobox">
    <abbr lwc:if={required} class="slds-required" title="required">*</abbr>
    {label}
  </label>

  <lightning-helptext lwc:if={fieldLevelHelp} content={fieldLevelHelp}></lightning-helptext>

  <div class="slds-form-element__control">
    <div class="slds-combobox_container">
      <div class={dropdownClass} aria-expanded={expanded} aria-haspopup="listbox" role="combobox">
        <div
          class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right"
          role="none"
        >
          <div
            aria-autocomplete="list"
            aria-disabled={disabled}
            class={comboboxClass}
            id="combobox"
            onclick={handleComboboxFocus}
          >
            <span lwc:if={empty} class="slds-text-color_weak"> {placeholder} </span>
            <div lwc:else class="slds-media">
              <span class="slds-media__body">
                <span class="slds-truncate" title={selection.label}> {selection.label} </span>
              </span>
            </div>
          </div>
          <div
            lwc:if={active}
            class="slds-input__icon-group slds-input__icon-group_right"
            onclick={handleComboboxIconClick}
          >
            <lightning-icon
              class={comboboxIconClass}
              icon-name={comboboxIcon}
              size="xx-small"
            ></lightning-icon>
          </div>
        </div>
        <div
          lwc:ref="listbox"
          id="listbox"
          class={listboxClass}
          onmousedown={handleListboxMouseDown}
          role="listbox"
        >
          <ul class="slds-listbox slds-listbox_vertical" role="presentation">
            <li role="presentation" class="slds-listbox__item">
              <div
                class="slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_term"
                role="option"
              >
                <span class="slds-media__figure slds-listbox__option-icon">
                  <lightning-icon icon-name="utility:search" size="x-small"></lightning-icon>
                </span>
                <span class="slds-media__body">
                  <div
                    class="slds-form-element__control slds-input-has-icon slds-input-has-icon_right"
                    role="none"
                  >
                    <input
                      autocomplete="off"
                      class="slds-input"
                      name={name}
                      type="text"
                      onblur={handleInputBlur}
                      oninput={handleInputChange}
                      onkeydown={handleInputKeyDown}
                      onmousedown={handleInputMouseDown}
                      placeholder={inputPlaceholder}
                    />

                    <div class="slds-input__icon-group slds-input__icon-group_right">
                      <div
                        lwc:if={loading}
                        class="slds-spinner slds-spinner_x-small slds-input__spinner"
                        role="status"
                      >
                        <span class="slds-assistive-text">Loading</span>
                        <div class="slds-spinner__dot-a"></div>
                        <div class="slds-spinner__dot-b"></div>
                      </div>
                    </div>
                  </div>
                </span>
              </div>
            </li>
            <template for:each={results} for:item="result">
              <li key={result.value} role="presentation" class="slds-listbox__item">
                <div
                  aria-disabled={result.disabled}
                  aria-selected={result.selected}
                  class={result.containerClass}
                  data-value={result.value}
                  role="option"
                  onmousedown={handleOptionClick}
                >
                  <span class="slds-media__figure slds-listbox__option-icon">
                    <lightning-icon
                      lwc:if={result.icon}
                      class={result.iconClass}
                      icon-name={result.icon}
                      size="small"
                    ></lightning-icon>
                  </span>
                  <span lwc:if={result.meta} class="slds-media__body">
                    <span class="slds-listbox__option-text slds-listbox__option-text_entity"
                      ><lightning-formatted-rich-text
                        value={result.label_matched}
                      ></lightning-formatted-rich-text>
                    </span>
                    <span class="slds-listbox__option-meta slds-listbox__option-meta_entity"
                      ><lightning-formatted-rich-text
                        value={result.meta_matched}
                      ></lightning-formatted-rich-text>
                    </span>
                  </span>
                  <span lwc:else class="slds-media__body">
                    <span class="slds-media__figure slds-listbox__option-icon"></span>
                    <span class="slds-media__body">
                      <span class="slds-truncate" title={result.label}>
                        <lightning-formatted-rich-text
                          value={result.label_matched}
                        ></lightning-formatted-rich-text>
                      </span>
                    </span>
                  </span>
                </div>
              </li>
            </template>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div
    lwc:if={validationInvalid}
    aria-live="assertive"
    class="slds-form-element__help"
    data-help-text="true"
  >
    {validationMessage}
  </div>
</template>
